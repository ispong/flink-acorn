#### 安装插件

##### 配置`SPARK_HOME`环境变量

```bash
sudo vim /etc/profile

# === sudo vim /etc/profile ===
export SPARK_HOME=/opt/cloudera/parcels/CDH/lib/spark
# === sudo vim /etc/profile ===

source /etc/profile
```

##### 下载源码

gitee

```bash
git clone https://gitee.com/ispong/spark-star.git
```

github

```bash
git clone https://github.com/ispong/spark-star.git
```

##### 配置hadoop文件

!> cdh版本需要提前把系统上的`core-site.xml`、`yarn-site.xml`、`hdfs-site.xml`、`mapred-site.xml`这四个文件打包到插件中的`star-plugin/src/main/resources`路径下

```bash
cp ${HADHOOP_HOME}/etc/hadoop/*.xml ${SPATK_STAR}/star-plugin/src/main/resources
```

##### 配置插件参数

!> 默认插件端口号 `30156`
> 默认spark session ui 端口号 `30166`
> hive-metastore-uris: ${hive.metastore.port}

```bash
vim ${SPATK_STAR}/star-plugin/src/main/resources/application-star.yml

# === vim ${SPATK_STAR}/star-plugin/src/main/resources/application.yml ===
server:
  port: 30156

star:
  config:
    app-name: spark star session
    master: yarn-client
    spark-ui-port: 30166
    hive-metastore-uris: thrift://172.23.39.206:30123 
# === vim ${SPATK_STAR}/star-plugin/src/main/resources/application-star.yml ===
```

##### 打包

```bash
cd ${SPATK_STAR}/star-plugin
mvn clean package
```

##### 启动插件

```bash
nohup java -jar -Xmx2048m ${SPATK_STAR}/star-plugin/target/star-plugin.jar >> ${SPATK_STAR}/star-plugin.log 2>&1 &
```

#### 客户端使用

##### 引入依赖

> Note:
> 如果引入依赖无法下载，可指定一下镜像仓库

```xml
<repositories>
    <repository>
        <id>s01.apache.snapshots</id>
        <name>S01 Apache Development Snapshot Repository</name>
        <url>https://s01.oss.sonatype.org/content/repositories/snapshots</url>
        <releases>
            <enabled>false</enabled>
        </releases>
        <snapshots>
            <enabled>true</enabled>
        </snapshots>
    </repository>
    <repository>
        <id>s01.apache.snapshots</id>
        <name>S01 Apache Development Snapshot Repository</name>
        <url>https://s01.oss.sonatype.org/service/local/staging/deploy/maven2/</url>
        <releases>
            <enabled>true</enabled>
        </releases>
        <snapshots>
            <enabled>false</enabled>
        </snapshots>
    </repository>
</repositories>
```

```xml
<dependency>
    <groupId>com.isxcode.star</groupId>
    <artifactId>star-common</artifactId>
    <version>0.0.3-SNAPSHOT</version>
</dependency>
```

##### 使用StarTemplate

```java
package com.isxcode.star.template;

import com.isxcode.star.common.pojo.entity.StarRequest;
import com.isxcode.star.common.pojo.entity.StarResponse;
import com.isxcode.star.common.template.StarTemplate;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RequestMapping
@RestController
@SpringBootApplication
public class TemplateApplication {

    private final StarTemplate starTemplate;

    public TemplateApplication(StarTemplate starTemplate) {
        this.starTemplate = starTemplate;
    }

    public static void main(String[] args) {
        SpringApplication.run(TemplateApplication.class, args);
    }

    @GetMapping("/demo")
    public StarResponse demo() {

        ExecuteConfig starRequest = ExecuteConfig.builder()
                .hasReturn(true)
                .sql("select * from rd_dev.ispong_table")
                .build();

        return starTemplate.executeSql("39.103.230.188", "30156", "key", starRequest);
    }
}
```

##### 测试

```http request
GET http://localhost:8080/demo
```

##### 返回示例

```json
```
